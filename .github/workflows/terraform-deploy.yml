name: üöÄ Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - apply
          - destroy
        default: 'apply'
      
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'

permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required to checkout code

jobs:
  deploy:
    name: üöÄ Deploy RDS Infrastructure
    runs-on: ubuntu-latest
    environment: dev
    
    outputs:
      rds_endpoint: ${{ steps.rds_output.outputs.endpoint }}
      rds_address: ${{ steps.rds_output.outputs.address }}
      rds_instance_id: ${{ steps.rds_output.outputs.instance_id }}
    
    defaults:
      run:
        working-directory: terraform
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        if: github.event.inputs.action != 'destroy'
        run: |
          terraform apply -auto-approve -input=false \
            -var="aws_region=${{ vars.AWS_REGION || 'us-east-1' }}" \
            -var="environment=dev" \
            -var="vpc_id=${{ secrets.VPC_ID }}" \
            -var='subnet_ids=${{ secrets.SUBNET_IDS }}' \
            -var='allowed_cidr_blocks=${{ secrets.ALLOWED_CIDR_BLOCKS }}' \
            -var="db_password=${{ secrets.DB_PASSWORD }}"

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: |
          terraform destroy -auto-approve -input=false \
            -var="aws_region=${{ vars.AWS_REGION || 'us-east-1' }}" \
            -var="environment=dev" \
            -var="vpc_id=${{ secrets.VPC_ID }}" \
            -var='subnet_ids=${{ secrets.SUBNET_IDS }}' \
            -var='allowed_cidr_blocks=${{ secrets.ALLOWED_CIDR_BLOCKS }}' \
            -var="db_password=${{ secrets.DB_PASSWORD }}"

      - name: Get RDS Endpoint
        if: github.event.inputs.action != 'destroy'
        id: rds_output
        run: |
          ENDPOINT=$(terraform output -raw rds_endpoint)
          ADDRESS=$(terraform output -raw rds_address)
          INSTANCE_ID=$(terraform output -raw rds_instance_id)
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
          echo "address=$ADDRESS" >> $GITHUB_OUTPUT
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Save RDS Endpoint
        if: github.event.inputs.action != 'destroy'
        run: |
          echo "üéâ RDS Endpoint: ${{ steps.rds_output.outputs.endpoint }}"
          echo "üìù Connection command: $(terraform output -raw mysql_cli_command)"

  migrate:
    name: üóÑÔ∏è Run Database Migrations
    needs: deploy
    if: github.event.inputs.action != 'destroy'
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Get RDS Endpoint from Deploy Job
        id: rds
        run: |
          echo "Using RDS endpoint from deploy job"
          echo "endpoint=${{ needs.deploy.outputs.rds_address }}" >> $GITHUB_OUTPUT

      - name: Wait for RDS to be available
        run: |
          echo "‚è≥ Waiting for RDS instance to be fully available..."
          INSTANCE_ID="${{ needs.deploy.outputs.rds_instance_id }}"
          
          for i in {1..30}; do
            STATUS=$(aws rds describe-db-instances \
              --db-instance-identifier "$INSTANCE_ID" \
              --query 'DBInstances[0].DBInstanceStatus' \
              --output text)
            
            echo "Attempt $i/30: Status = $STATUS"
            
            if [ "$STATUS" = "available" ]; then
              echo "‚úÖ RDS is available!"
              break
            fi
            
            if [ $i -eq 30 ]; then
              echo "‚ùå Timeout waiting for RDS to become available"
              exit 1
            fi
            
            sleep 10
          done

      - name: Run Flyway Migrations
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/migrations/sql:/flyway/sql \
            flyway/flyway:10-alpine \
            -url=jdbc:mysql://${{ steps.rds.outputs.endpoint }}:3306/smart_workshop \
            -user=admin \
            -password="${{ secrets.DB_PASSWORD }}" \
            -connectRetries=60 \
            -baselineOnMigrate=true \
            migrate

      - name: Show Migration Status
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/migrations/sql:/flyway/sql \
            flyway/flyway:10-alpine \
            -url=jdbc:mysql://${{ steps.rds.outputs.endpoint }}:3306/smart_workshop \
            -user=admin \
            -password="${{ secrets.DB_PASSWORD }}" \
            info
        
      - name: Migration Summary
        run: |
          echo "‚úÖ Database migrations completed successfully!"
          echo "üìä Check the 'Show Migration Status' step above for details"
