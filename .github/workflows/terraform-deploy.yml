name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - apply
          - destroy
        default: 'apply'
      
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'

permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required to checkout code

jobs:
  deploy:
    name: Deploy RDS Infrastructure
    runs-on: ubuntu-latest
    environment: dev
    
    defaults:
      run:
        working-directory: terraform
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        if: github.event.inputs.action != 'destroy'
        run: |
          terraform apply -auto-approve -input=false \
            -var="aws_region=${{ vars.AWS_REGION || 'us-east-1' }}" \
            -var="environment=dev" \
            -var="vpc_id=${{ secrets.VPC_ID }}" \
            -var='subnet_ids=${{ secrets.SUBNET_IDS }}' \
            -var='allowed_cidr_blocks=${{ secrets.ALLOWED_CIDR_BLOCKS }}'

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: |
          terraform destroy -auto-approve -input=false \
            -var="aws_region=${{ vars.AWS_REGION || 'us-east-1' }}" \
            -var="environment=dev" \
            -var="vpc_id=${{ secrets.VPC_ID }}" \
            -var='subnet_ids=${{ secrets.SUBNET_IDS }}' \
            -var='allowed_cidr_blocks=${{ secrets.ALLOWED_CIDR_BLOCKS }}'

      - name: Get RDS Endpoint
        if: github.event.inputs.action != 'destroy'
        id: rds_output
        run: |
          ENDPOINT=$(terraform output -raw rds_endpoint)
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT

      - name: Save RDS Endpoint
        if: github.event.inputs.action != 'destroy'
        run: |
          echo "RDS Endpoint: ${{ steps.rds_output.outputs.endpoint }}"
          echo "Connection command: $(terraform output -raw mysql_cli_command)"

  migrate:
    name: Run Database Migrations
    needs: deploy
    if: github.event.inputs.action != 'destroy'
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Get RDS credentials from Secrets Manager
        id: get_secret
        run: |
          SECRET_ARN=$(aws rds describe-db-instances \
            --db-instance-identifier $(aws rds describe-db-instances \
              --query 'DBInstances[?DBName==`smart_workshop`].DBInstanceIdentifier' \
              --output text) \
            --query 'DBInstances[0].MasterUserSecret.SecretArn' \
            --output text)
          
          SECRET=$(aws secretsmanager get-secret-value \
            --secret-id $SECRET_ARN \
            --query SecretString \
            --output text)
          
          PASSWORD=$(echo $SECRET | jq -r .password)
          echo "::add-mask::$PASSWORD"
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT

      - name: Get RDS Endpoint
        id: rds_endpoint
        working-directory: terraform
        run: |
          cd terraform
          terraform init
          ENDPOINT=$(terraform output -raw rds_address)
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT

      - name: Run Flyway Migrations
        uses: docker://flyway/flyway:10-alpine
        env:
          FLYWAY_URL: jdbc:mysql://${{ steps.rds_endpoint.outputs.endpoint }}:3306/smart_workshop
          FLYWAY_USER: admin
          FLYWAY_PASSWORD: ${{ steps.get_secret.outputs.password }}
          FLYWAY_LOCATIONS: filesystem:/flyway/sql
          FLYWAY_CONNECT_RETRIES: 60
          FLYWAY_BASELINE_ON_MIGRATE: true
        with:
          args: migrate

      - name: Flyway Info
        uses: docker://flyway/flyway:10-alpine
        env:
          FLYWAY_URL: jdbc:mysql://${{ steps.rds_endpoint.outputs.endpoint }}:3306/smart_workshop
          FLYWAY_USER: admin
          FLYWAY_PASSWORD: ${{ steps.get_secret.outputs.password }}
          FLYWAY_LOCATIONS: filesystem:/flyway/sql
        with:
          args: info
