name: ğŸ”„ RDS Start/Stop

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'AÃ§Ã£o a executar'
        required: true
        type: choice
        options:
          - start
          - stop
        default: 'stop'
      
      enable_schedule:
        description: 'Habilitar schedule automÃ¡tico? (start 07h / stop 20h BrasÃ­lia)'
        required: false
        type: boolean
        default: false
  
  # Schedule: Liga Ã s 07h BRT (10h UTC), Para Ã s 20h BRT (23h UTC)
  schedule:
    - cron: '0 10 * * 1-5'  # Liga Ã s 10h UTC = 07h BRT (seg-sex)
    - cron: '0 23 * * 1-5'  # Para Ã s 23h UTC = 20h BRT (seg-sex)

permissions:
  id-token: write   # OIDC
  contents: read

jobs:
  manage-rds:
    name: ğŸ”„ ${{ github.event.inputs.action == 'start' && 'Iniciar' || github.event_name == 'schedule' && (github.event.schedule == '0 8 * * 1-5' && 'Iniciar' || 'Parar') || 'Parar' }} RDS
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-west-2' }}

      - name: Determinar aÃ§Ã£o (manual ou schedule)
        id: determine_action
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # Schedule: 10h UTC (07h BRT) = start, 23h UTC (20h BRT) = stop
            if [ "${{ github.event.schedule }}" = "0 10 * * 1-5" ]; then
              ACTION="start"
              echo "ğŸ“… Schedule trigger: Iniciar RDS (10h UTC = 07h BrasÃ­lia)"
            else
              ACTION="stop"
              echo "ğŸ“… Schedule trigger: Parar RDS (23h UTC = 20h BrasÃ­lia)"
            fi
          else
            # Manual
            ACTION="${{ github.event.inputs.action }}"
            echo "ğŸ–±ï¸ Manual trigger: $ACTION"
          fi
          
          echo "action=$ACTION" >> $GITHUB_OUTPUT

      - name: Verificar estado atual do RDS
        id: check_status
        run: |
          INSTANCE_ID="smart-workshop-dev-db"
          
          echo "ğŸ” Verificando estado do RDS: $INSTANCE_ID"
          
          # Obter status atual
          STATUS=$(aws rds describe-db-instances \
            --db-instance-identifier "$INSTANCE_ID" \
            --query 'DBInstances[0].DBInstanceStatus' \
            --output text)
          
          echo "ğŸ“Š Status atual: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          
          # Verificar se jÃ¡ estÃ¡ no estado desejado
          ACTION="${{ steps.determine_action.outputs.action }}"
          
          if [ "$ACTION" = "stop" ] && [ "$STATUS" = "stopped" ]; then
            echo "already_correct=true" >> $GITHUB_OUTPUT
            echo "âœ… RDS jÃ¡ estÃ¡ parado. Nenhuma aÃ§Ã£o necessÃ¡ria."
            exit 0
          elif [ "$ACTION" = "stop" ] && [ "$STATUS" = "stopping" ]; then
            echo "already_correct=true" >> $GITHUB_OUTPUT
            echo "â³ RDS jÃ¡ estÃ¡ sendo parado. Aguardando conclusÃ£o..."
            exit 0
          elif [ "$ACTION" = "start" ] && [ "$STATUS" = "available" ]; then
            echo "already_correct=true" >> $GITHUB_OUTPUT
            echo "âœ… RDS jÃ¡ estÃ¡ disponÃ­vel. Nenhuma aÃ§Ã£o necessÃ¡ria."
            exit 0
          elif [ "$ACTION" = "start" ] && [ "$STATUS" = "starting" ]; then
            echo "already_correct=true" >> $GITHUB_OUTPUT
            echo "â³ RDS jÃ¡ estÃ¡ sendo iniciado. Aguardando conclusÃ£o..."
            exit 0
          fi
          
          echo "already_correct=false" >> $GITHUB_OUTPUT

      - name: Parar RDS
        if: steps.determine_action.outputs.action == 'stop' && steps.check_status.outputs.already_correct == 'false'
        id: stop_rds
        run: |
          INSTANCE_ID="smart-workshop-dev-db"
          
          echo "ğŸ›‘ Parando RDS: $INSTANCE_ID"
          
          aws rds stop-db-instance \
            --db-instance-identifier "$INSTANCE_ID"
          
          echo "â±ï¸ Tempo estimado: 2-3 minutos"
          echo "ğŸ’° Economia estimada (com schedule 07h-20h seg-sex):"
          echo "   â€¢ Horas paradas/dia: 11h (20h-07h) = ~$5.50/dia"
          echo "   â€¢ Economia semanal: ~$27.50 (seg-sex) + $24 (fim de semana) = ~$51.50"
          echo "   â€¢ Economia mensal: ~$206/mÃªs (~57% do custo total)"
          echo "âš ï¸ LimitaÃ§Ã£o AWS: RDS serÃ¡ religado automaticamente apÃ³s 7 dias parado"
          
          # Aguardar atÃ© status = stopping
          echo ""
          echo "â³ Aguardando RDS comeÃ§ar a parar..."
          for i in {1..30}; do
            sleep 5
            STATUS=$(aws rds describe-db-instances \
              --db-instance-identifier "$INSTANCE_ID" \
              --query 'DBInstances[0].DBInstanceStatus' \
              --output text)
            
            echo "Tentativa $i/30: Status = $STATUS"
            
            if [ "$STATUS" = "stopping" ] || [ "$STATUS" = "stopped" ]; then
              echo "âœ… RDS estÃ¡ parando/parado!"
              break
            fi
          done

      - name: Iniciar RDS
        if: steps.determine_action.outputs.action == 'start' && steps.check_status.outputs.already_correct == 'false'
        id: start_rds
        run: |
          INSTANCE_ID="smart-workshop-dev-db"
          
          echo "ğŸš€ Iniciando RDS: $INSTANCE_ID"
          
          aws rds start-db-instance \
            --db-instance-identifier "$INSTANCE_ID"
          
          echo "â±ï¸ Tempo estimado: 5-10 minutos"
          
          # Aguardar atÃ© status = starting
          echo ""
          echo "â³ Aguardando RDS comeÃ§ar a iniciar..."
          for i in {1..30}; do
            sleep 5
            STATUS=$(aws rds describe-db-instances \
              --db-instance-identifier "$INSTANCE_ID" \
              --query 'DBInstances[0].DBInstanceStatus' \
              --output text)
            
            echo "Tentativa $i/30: Status = $STATUS"
            
            if [ "$STATUS" = "starting" ] || [ "$STATUS" = "available" ]; then
              echo "âœ… RDS estÃ¡ iniciando/disponÃ­vel!"
              break
            fi
          done

      - name: Resumo Final
        if: always()
        run: |
          INSTANCE_ID="smart-workshop-dev-db"
          ACTION="${{ steps.determine_action.outputs.action }}"
          ALREADY_CORRECT="${{ steps.check_status.outputs.already_correct }}"
          INITIAL_STATUS="${{ steps.check_status.outputs.status }}"
          
          # Status atual
          CURRENT_STATUS=$(aws rds describe-db-instances \
            --db-instance-identifier "$INSTANCE_ID" \
            --query 'DBInstances[0].DBInstanceStatus' \
            --output text 2>/dev/null || echo "unknown")
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              RESUMO - RDS START/STOP                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ†” InstÃ¢ncia:       $INSTANCE_ID"
          echo "ğŸ¬ AÃ§Ã£o solicitada: $ACTION"
          echo "ğŸ“Š Status inicial:  $INITIAL_STATUS"
          echo "ğŸ“Š Status final:    $CURRENT_STATUS"
          echo ""
          
          if [ "$ALREADY_CORRECT" = "true" ]; then
            echo "â„¹ï¸  Nenhuma aÃ§Ã£o foi necessÃ¡ria (RDS jÃ¡ estava no estado correto)"
          else
            if [ "$ACTION" = "stop" ]; then
              echo "âœ… Comando de parada enviado com sucesso"
              echo "ğŸ’° Economia estimada (schedule 07h-20h BrasÃ­lia):"
              echo "   â€¢ Por hora parado:     ~$0.50"
              echo "   â€¢ Por dia (11h parado): ~$5.50"
              echo "   â€¢ Por semana:          ~$51.50"
              echo "   â€¢ Por mÃªs:             ~$206.00 (~57% do custo)"
              echo ""
              echo "âš ï¸  ATENÃ‡ÃƒO: AWS reinicia RDS automaticamente apÃ³s 7 dias parado"
            else
              echo "âœ… Comando de inicializaÃ§Ã£o enviado com sucesso"
              echo "â±ï¸  RDS estarÃ¡ disponÃ­vel em aproximadamente 5-10 minutos"
              echo ""
              echo "ğŸ“ Para conectar:"
              echo "   Host: smart-workshop-dev-db.c768oyw0y804.us-west-2.rds.amazonaws.com"
              echo "   Port: 3306"
              echo "   DB:   smart_workshop"
            fi
          fi
          echo ""
          echo "ğŸ”— Endpoint: $(aws rds describe-db-instances \
            --db-instance-identifier "$INSTANCE_ID" \
            --query 'DBInstances[0].Endpoint.Address' \
            --output text 2>/dev/null || echo 'Aguardando inicializaÃ§Ã£o...')"
          echo ""

      - name: Verificar configuraÃ§Ã£o de schedule
        if: github.event.inputs.enable_schedule == 'true' && github.event_name == 'workflow_dispatch'
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           SCHEDULE AUTOMÃTICO CONFIGURADO                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â° Schedule configurado neste workflow:"
          echo ""
          echo "   ğŸŒ… Ligar RDS:  Segunda a Sexta Ã s 08:00 UTC (05:00 BRT)"
          echo "   ğŸŒ™ Parar RDS:  Segunda a Sexta Ã s 19:00 UTC (16:00 BRT)"
          echo ""
          echo "ğŸ“Š Economia estimada com schedule:"
          echo "   â€¢ 11 horas parado por dia Ãºtil (19h-8h)"
          echo "   â€¢ 48 horas parado por fim de semana"
          echo "   â€¢ Total: ~103 horas/semana economizadas"
          echo "   â€¢ Economia: ~$215/mÃªs vs 24/7"
          echo ""
          echo "â„¹ï¸  O schedule estÃ¡ ATIVO e rodarÃ¡ automaticamente"
          echo "â„¹ï¸  Para desabilitar, edite .github/workflows/rds-start-stop.yml"
