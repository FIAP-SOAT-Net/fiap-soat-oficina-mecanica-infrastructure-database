name: ğŸ³ Publish Docker Image

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Tipo de incremento da versÃ£o (Semantic Versioning)'
        required: true
        type: choice
        options:
          - PATCH  # 1.0.0 â†’ 1.0.1 (bugfix, pequenas mudanÃ§as)
          - MINOR  # 1.0.0 â†’ 1.1.0 (nova feature, compatÃ­vel)
          - MAJOR  # 1.0.0 â†’ 2.0.0 (breaking change)
        default: 'PATCH'

permissions:
  contents: write  # NecessÃ¡rio para criar tags
  packages: write  # Caso use GHCR no futuro

jobs:
  build-and-push:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NecessÃ¡rio para obter todas as tags

      - name: Validar estrutura do projeto
        run: |
          echo "ğŸ“‚ Verificando estrutura do projeto..."
          
          if [ ! -f "Dockerfile" ]; then
            echo "âŒ Dockerfile nÃ£o encontrado!"
            exit 1
          fi
          
          if [ ! -d "migrations/sql" ]; then
            echo "âŒ DiretÃ³rio migrations/sql nÃ£o encontrado!"
            exit 1
          fi
          
          MIGRATION_COUNT=$(ls -1 migrations/sql/*.sql 2>/dev/null | wc -l)
          if [ "$MIGRATION_COUNT" -eq 0 ]; then
            echo "âŒ Nenhuma migration encontrada em migrations/sql/"
            exit 1
          fi
          
          echo "âœ… Estrutura validada:"
          echo "   - Dockerfile: âœ“"
          echo "   - Migrations: $MIGRATION_COUNT arquivo(s)"

      - name: Obter Ãºltima tag e calcular nova versÃ£o
        id: version
        run: |
          echo "ğŸ·ï¸  Obtendo Ãºltima tag do repositÃ³rio..."
          
          # Obter todas as tags no formato vX.Y.Z
          LAST_TAG=$(git tag -l "v*.*.*" | sort -V | tail -n 1)
          
          if [ -z "$LAST_TAG" ]; then
            echo "â„¹ï¸  Nenhuma tag encontrada. Iniciando com v1.0.0"
            LAST_TAG="v0.0.0"
          fi
          
          echo "ğŸ“Œ Ãšltima tag: $LAST_TAG"
          
          # Extrair nÃºmeros da versÃ£o (remover 'v' prefix)
          VERSION=${LAST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Incrementar conforme o tipo escolhido
          BUMP_TYPE="${{ github.event.inputs.version_bump }}"
          
          case "$BUMP_TYPE" in
            MAJOR)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            MINOR)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            PATCH)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          NEW_TAG="v$NEW_VERSION"
          
          echo "ğŸ†• Nova versÃ£o: $NEW_TAG (bump: $BUMP_TYPE)"
          
          # Exportar para prÃ³ximos steps
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT

      - name: Verificar se hÃ¡ mudanÃ§as desde Ãºltima tag
        id: check_changes
        run: |
          LAST_TAG="${{ steps.version.outputs.last_tag }}"
          
          echo "ğŸ” Verificando mudanÃ§as desde $LAST_TAG..."
          
          # Se Ã© a primeira tag, sempre permitir
          if [ "$LAST_TAG" = "v0.0.0" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Primeira tag - prosseguindo com build"
            exit 0
          fi
          
          # Verificar se houve commits desde a Ãºltima tag
          COMMITS_SINCE_TAG=$(git rev-list ${LAST_TAG}..HEAD --count)
          
          echo "ğŸ“Š Commits desde $LAST_TAG: $COMMITS_SINCE_TAG"
          
          if [ "$COMMITS_SINCE_TAG" -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Nenhum commit novo desde a Ãºltima tag!"
            echo "âŒ Build cancelado - nÃ£o hÃ¡ mudanÃ§as para versionar"
            exit 1
          fi
          
          # Verificar se houve mudanÃ§as relevantes (migrations, Dockerfile, etc)
          RELEVANT_CHANGES=$(git diff --name-only ${LAST_TAG}..HEAD | \
            grep -E '(migrations/|Dockerfile|docker/)' | wc -l)
          
          echo "ğŸ“ Arquivos relevantes alterados: $RELEVANT_CHANGES"
          
          if [ "$RELEVANT_CHANGES" -eq 0 ]; then
            echo "âš ï¸  Nenhuma mudanÃ§a relevante detectada em:"
            echo "   - migrations/"
            echo "   - Dockerfile"
            echo "   - docker/"
            echo ""
            echo "â„¹ï¸  Continuando mesmo assim (hÃ¡ outros commits)..."
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… MudanÃ§as detectadas - prosseguindo com build"

      - name: Verificar se tag jÃ¡ existe
        run: |
          NEW_TAG="${{ steps.version.outputs.new_tag }}"
          
          echo "ğŸ” Verificando se tag $NEW_TAG jÃ¡ existe..."
          
          if git rev-parse "$NEW_TAG" >/dev/null 2>&1; then
            echo "âŒ Tag $NEW_TAG jÃ¡ existe no repositÃ³rio!"
            echo "â„¹ï¸  Use um version_bump maior ou delete a tag existente"
            exit 1
          fi
          
          echo "âœ… Tag $NEW_TAG disponÃ­vel"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extrair metadata do Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: igortessaro/smart-mechanical-workshop-db
          tags: |
            type=raw,value=${{ steps.version.outputs.new_version }}
            type=raw,value=latest
            type=sha,prefix=sha-,format=short

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            GIT_COMMIT_SHA=${{ github.sha }}
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VERSION=${{ steps.version.outputs.new_version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Testar imagem Docker
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          IMAGE="igortessaro/smart-mechanical-workshop-db:$NEW_VERSION"
          
          echo "ğŸ§ª Testando imagem: $IMAGE"
          
          # Iniciar container
          echo "ğŸš€ Iniciando container de teste..."
          docker run -d \
            --name test-mysql \
            -e MYSQL_ROOT_PASSWORD=test_root_password \
            -e MYSQL_DATABASE=smart_workshop \
            -e MYSQL_USER=test_user \
            -e MYSQL_PASSWORD=test_password \
            -p 3307:3306 \
            "$IMAGE"
          
          # Aguardar MySQL ficar pronto
          echo "â³ Aguardando MySQL inicializar..."
          for i in {1..30}; do
            if docker exec test-mysql mysqladmin ping -h localhost -uroot -ptest_root_password --silent 2>/dev/null; then
              echo "âœ… MySQL estÃ¡ pronto!"
              break
            fi
            echo "Tentativa $i/30..."
            sleep 2
          done
          
          # Aguardar mais um pouco para garantir que o MySQL estÃ¡ completamente inicializado
          echo "â³ Aguardando finalizaÃ§Ã£o da inicializaÃ§Ã£o..."
          sleep 5
          
          # Verificar se migrations foram aplicadas
          echo ""
          echo "ğŸ” Verificando migrations aplicadas..."
          docker exec test-mysql mysql -h 127.0.0.1 -uroot -ptest_root_password smart_workshop \
            -e "SHOW TABLES;" 2>/dev/null || {
              echo "âŒ Erro ao consultar tabelas!"
              docker logs test-mysql
              exit 1
            }
          
          # Verificar versÃ£o do MySQL
          echo ""
          echo "ğŸ“Š VersÃ£o do MySQL:"
          docker exec test-mysql mysql -h 127.0.0.1 -uroot -ptest_root_password \
            -e "SELECT VERSION();" 2>/dev/null
          
          # Cleanup
          echo ""
          echo "ğŸ§¹ Limpando container de teste..."
          docker stop test-mysql
          docker rm test-mysql
          
          echo "âœ… Imagem testada com sucesso!"

      - name: Criar Git Tag
        run: |
          NEW_TAG="${{ steps.version.outputs.new_tag }}"
          
          echo "ğŸ·ï¸  Criando tag $NEW_TAG..."
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a "$NEW_TAG" -m "Release $NEW_TAG

          ğŸ“¦ Docker Image: igortessaro/smart-mechanical-workshop-db:${{ steps.version.outputs.new_version }}
          ğŸ”„ Version Bump: ${{ github.event.inputs.version_bump }}
          ğŸ“ Commit: ${{ github.sha }}
          ğŸ‘¤ Triggered by: ${{ github.actor }}
          "
          
          git push origin "$NEW_TAG"
          
          echo "âœ… Tag $NEW_TAG criada e pushed!"

      - name: Criar GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.new_tag }}
          name: Release ${{ steps.version.outputs.new_tag }}
          body: |
            ## ğŸ³ Docker Image Release
            
            **VersÃ£o:** `${{ steps.version.outputs.new_version }}`  
            **Tipo:** `${{ github.event.inputs.version_bump }}`  
            **Commit:** `${{ github.sha }}`
            
            ### ğŸ“¦ Imagens DisponÃ­veis
            
            ```bash
            # VersÃ£o especÃ­fica
            docker pull igortessaro/smart-mechanical-workshop-db:${{ steps.version.outputs.new_version }}
            
            # Latest
            docker pull igortessaro/smart-mechanical-workshop-db:latest
            
            # Major version
            docker pull igortessaro/smart-mechanical-workshop-db:${{ steps.version.outputs.major }}
            
            # Major.Minor version
            docker pull igortessaro/smart-mechanical-workshop-db:${{ steps.version.outputs.major }}.${{ steps.version.outputs.minor }}
            ```
            
            ### ğŸš€ Como usar
            
            ```bash
            # Executar container
            docker run -d \
              --name smart-workshop-db \
              -e MYSQL_ROOT_PASSWORD=your_root_password \
              -e MYSQL_DATABASE=smart_workshop \
              -e MYSQL_USER=workshop_user \
              -e MYSQL_PASSWORD=your_password \
              -p 3306:3306 \
              igortessaro/smart-mechanical-workshop-db:${{ steps.version.outputs.new_version }}
            
            # Conectar
            mysql -h 127.0.0.1 -P 3306 -u workshop_user -p smart_workshop
            ```
            
            ### ğŸ“‹ Migrations IncluÃ­das
            
            Todas as migrations em `migrations/sql/` foram aplicadas automaticamente.
            
            ### ğŸ”— Links
            
            - [Docker Hub](https://hub.docker.com/r/igortessaro/smart-mechanical-workshop-db)
            - [DocumentaÃ§Ã£o](https://github.com/${{ github.repository }}/blob/main/README.md)
            - [Changelog](https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.last_tag }}...${{ steps.version.outputs.new_tag }})
          draft: false
          prerelease: false

      - name: Resumo Final
        if: always()
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          NEW_TAG="${{ steps.version.outputs.new_tag }}"
          BUMP_TYPE="${{ github.event.inputs.version_bump }}"
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           DOCKER IMAGE PUBLICADA COM SUCESSO                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ·ï¸  Tag Git:        $NEW_TAG"
          echo "ğŸ“¦ VersÃ£o Docker:  $NEW_VERSION"
          echo "ğŸ”„ Tipo de Bump:   $BUMP_TYPE"
          echo "ğŸ“ Commit SHA:     ${{ github.sha }}"
          echo ""
          echo "ğŸ³ Imagens publicadas:"
          echo "   â€¢ igortessaro/smart-mechanical-workshop-db:$NEW_VERSION"
          echo "   â€¢ igortessaro/smart-mechanical-workshop-db:latest"
          echo ""
          echo "ğŸ”— Docker Hub:"
          echo "   https://hub.docker.com/r/igortessaro/smart-mechanical-workshop-db"
          echo ""
          echo "ğŸ“¦ Pull command:"
          echo "   docker pull igortessaro/smart-mechanical-workshop-db:$NEW_VERSION"
          echo ""
